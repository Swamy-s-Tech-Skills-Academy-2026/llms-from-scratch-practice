# Python CI - PyTorch LLM Implementation
# Tests core logic in src/ with pytest

name: Python CI

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'requirements.txt'
      - '.github/workflows/ci-python.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'requirements.txt'
      - '.github/workflows/ci-python.yml'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install pytorch (CPU version for CI speed) and dev tools
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install numpy pytest flake8 black isort
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Check formatting with Black
        run: |
          if [ -d "src" ] && [ "$(ls -A src)" ]; then
             black --check --diff src
          fi

      - name: Check import sorting with isort
        run: |
          if [ -d "src" ] && [ "$(ls -A src)" ]; then
             isort --check-only --diff src
          fi

      - name: Lint with flake8
        run: |
          if [ -d "src" ] && [ "$(ls -A src)" ]; then
             # Stop the build if there are Python syntax errors or undefined names
             flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics
             # Check for style violations
             flake8 src --count --max-complexity=10 --max-line-length=100 --statistics
          fi

      - name: Run tests with pytest
        run: |
          # Run tests if src or tests folder exists
          # Allow exit code 5 (no tests found) for early stage
          if [ -d "src" ] || [ -d "tests" ]; then
             pytest || ( [ $? = 5 ] && exit 0 || exit $? )
          fi
