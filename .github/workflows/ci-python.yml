# Python CI - PyTorch LLM Implementation
# Tests core logic in src/ with pytest

name: Python CI

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - '.github/workflows/ci-python.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - '.github/workflows/ci-python.yml'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install uv
        uses: astral-sh/setup-uv@v2

      - name: Install dependencies
        run: uv sync --group dev

      - name: Check formatting with Black
        run: |
          if [ -d "src" ] && [ "$(ls -A src)" ]; then
             uv run black --check --diff src
          fi

      - name: Check import sorting with isort
        run: |
          if [ -d "src" ] && [ "$(ls -A src)" ]; then
             uv run isort --check-only --diff src
          fi

      - name: Lint with flake8
        run: |
          if [ -d "src" ] && [ "$(ls -A src)" ]; then
             # Stop the build if there are Python syntax errors or undefined names
             uv run flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics
             # Check for style violations
             uv run flake8 src --count --max-complexity=10 --max-line-length=100 --statistics
          fi

      - name: Run tests with pytest
        run: |
          # Run tests if src or tests folder exists
          # Allow exit code 5 (no tests found) for early stage
          if [ -d "src" ] || [ -d "tests" ]; then
             uv run pytest || ( [ $? = 5 ] && exit 0 || exit $? )
          fi
